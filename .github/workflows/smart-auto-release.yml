name: ğŸ§  Smart Auto Release

# ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø£ÙŠ push Ø¹Ù„Ù‰ main
on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE*'

  # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ Ù„Ù„ÙØ­Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  schedule:
    - cron: '0 2 * * *'  # ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹

  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
  analyze-changes:
    name: ğŸ” Smart Change Analysis
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.analysis.outputs.should_release }}
      version_bump: ${{ steps.analysis.outputs.version_bump }}
      release_type: ${{ steps.analysis.outputs.release_type }}
      changelog: ${{ steps.analysis.outputs.changelog }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ§  Intelligent Analysis
        id: analysis
        run: |
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"
          
          # ØªØ­Ù„ÙŠÙ„ Ø§Ù„commits Ù…Ù†Ø° Ø¢Ø®Ø± tag
          COMMITS=$(git log $LAST_TAG..HEAD --oneline)
          echo "Commits since last tag:"
          echo "$COMMITS"
          
          # ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù†ÙˆØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          MAJOR_CHANGES=$(echo "$COMMITS" | grep -i "BREAKING\|major\|breaking change" | wc -l)
          MINOR_CHANGES=$(echo "$COMMITS" | grep -i "feat\|feature\|add\|new" | wc -l)
          PATCH_CHANGES=$(echo "$COMMITS" | grep -i "fix\|bug\|patch\|update" | wc -l)
          
          # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          if [ $MAJOR_CHANGES -gt 0 ]; then
            VERSION_BUMP="major"
            RELEASE_TYPE="release"
          elif [ $MINOR_CHANGES -gt 0 ]; then
            VERSION_BUMP="minor"
            RELEASE_TYPE="release"
          elif [ $PATCH_CHANGES -gt 0 ]; then
            VERSION_BUMP="patch"
            RELEASE_TYPE="release"
          else
            VERSION_BUMP="patch"
            RELEASE_TYPE="draft"
          fi
          
          # ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø¥ØµØ¯Ø§Ø±
          TOTAL_CHANGES=$((MAJOR_CHANGES + MINOR_CHANGES + PATCH_CHANGES))
          if [ $TOTAL_CHANGES -gt 0 ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHOULD_RELEASE="true"
          else
            SHOULD_RELEASE="false"
          fi
          
          # Ø¥Ù†Ø´Ø§Ø¡ changelog ØªÙ„Ù‚Ø§Ø¦ÙŠ
          CHANGELOG="## ğŸ‰ What's New\n\n"
          
          if [ $MAJOR_CHANGES -gt 0 ]; then
            CHANGELOG="${CHANGELOG}### ğŸ’¥ Breaking Changes\n"
            echo "$COMMITS" | grep -i "BREAKING\|major\|breaking change" | sed 's/^/- /' >> changelog_temp.md
            CHANGELOG="${CHANGELOG}$(cat changelog_temp.md)\n\n"
          fi
          
          if [ $MINOR_CHANGES -gt 0 ]; then
            CHANGELOG="${CHANGELOG}### âœ¨ New Features\n"
            echo "$COMMITS" | grep -i "feat\|feature\|add\|new" | sed 's/^/- /' >> changelog_temp.md
            CHANGELOG="${CHANGELOG}$(cat changelog_temp.md)\n\n"
          fi
          
          if [ $PATCH_CHANGES -gt 0 ]; then
            CHANGELOG="${CHANGELOG}### ğŸ› Bug Fixes\n"
            echo "$COMMITS" | grep -i "fix\|bug\|patch\|update" | sed 's/^/- /' >> changelog_temp.md
            CHANGELOG="${CHANGELOG}$(cat changelog_temp.md)\n\n"
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
          CHANGELOG="${CHANGELOG}### ğŸ“Š Statistics\n"
          CHANGELOG="${CHANGELOG}- Total commits: $(echo "$COMMITS" | wc -l)\n"
          CHANGELOG="${CHANGELOG}- Files changed: $(git diff --name-only $LAST_TAG..HEAD | wc -l)\n"
          CHANGELOG="${CHANGELOG}- Build date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n"
          
          # ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "version_bump=$VERSION_BUMP" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          echo "ğŸ” Analysis Results:"
          echo "Should Release: $SHOULD_RELEASE"
          echo "Version Bump: $VERSION_BUMP"
          echo "Release Type: $RELEASE_TYPE"
          echo "Major Changes: $MAJOR_CHANGES"
          echo "Minor Changes: $MINOR_CHANGES"
          echo "Patch Changes: $PATCH_CHANGES"

  # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  auto-version:
    name: ğŸ·ï¸ Auto Version & Tag
    needs: analyze-changes
    runs-on: ubuntu-latest
    if: needs.analyze-changes.outputs.should_release == 'true'
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ·ï¸ Auto Version Bump
        id: version
        run: |
          # Ø¥Ø¹Ø¯Ø§Ø¯ git
          git config user.name "Smart Auto Release Bot"
          git config user.email "actions@github.com"
          
          # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          NEW_VERSION=$(npm version ${{ needs.analyze-changes.outputs.version_bump }} --no-git-tag-version)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
          echo "Updating version in additional files..."
          
          # ØªØ­Ø¯ÙŠØ« quasar.config.ts
          if [ -f "quasar.config.ts" ]; then
            sed -i "s/version: '[^']*'/version: '$NEW_VERSION'/g" quasar.config.ts
          fi
          
          # commit Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          git add .
          git commit -m "ğŸš€ Auto bump version to $NEW_VERSION
          
          - Version bump: ${{ needs.analyze-changes.outputs.version_bump }}
          - Release type: ${{ needs.analyze-changes.outputs.release_type }}
          - Auto-generated by Smart Release Bot"
          
          # Ø¥Ù†Ø´Ø§Ø¡ tag
          git tag -a "$NEW_VERSION" -m "ğŸ‰ Release $NEW_VERSION
          
          ${{ needs.analyze-changes.outputs.changelog }}"
          
          # push Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ§Ù„tag
          git push origin main
          git push origin "$NEW_VERSION"
          
          echo "âœ… Version bumped to $NEW_VERSION and tag created"

  # Ø¨Ù†Ø§Ø¡ ÙˆÙ†Ø´Ø± Ø°ÙƒÙŠ
  smart-build-release:
    name: ğŸš€ Smart Build & Release
    needs: [analyze-changes, auto-version]
    if: needs.analyze-changes.outputs.should_release == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win32
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: x64
          - os: ubuntu-latest
            platform: linux
            arch: x64
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.auto-version.outputs.new_version }}
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ§ª Smart Testing
        run: |
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
          npm run test:unit 2>/dev/null || echo "No unit tests found"
          npm run lint || echo "Linting completed with warnings"
          npm run type-check || echo "Type checking completed"
        continue-on-error: true
      
      - name: ğŸ—ï¸ Build Application
        run: npm run build
      
      - name: ğŸš€ Smart Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ØªØ­Ø¯ÙŠØ¯ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„
          if [ "${{ needs.analyze-changes.outputs.release_type }}" = "release" ]; then
            echo "ğŸ‰ Publishing as stable release"
            npm run build:electron -- --publish always
          else
            echo "ğŸ“ Publishing as draft release"
            npm run build:electron -- --publish onTagOrDraft
          fi

  # Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©
  smart-notifications:
    name: ğŸ“¢ Smart Notifications
    needs: [analyze-changes, auto-version, smart-build-release]
    runs-on: ubuntu-latest
    if: always() && needs.analyze-changes.outputs.should_release == 'true'
    
    steps:
      - name: ğŸ“Š Create Smart Summary
        run: |
          echo "## ğŸ§  Smart Auto Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version:** ${{ needs.auto-version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Bump:** ${{ needs.analyze-changes.outputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Type:** ${{ needs.analyze-changes.outputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ${{ needs.smart-build-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Changelog" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.analyze-changes.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“¥ Download Latest Release](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“‹ All Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ”„ Auto-Update in App]()" >> $GITHUB_STEP_SUMMARY

  # ØªÙ†Ø¸ÙŠÙ Ø°ÙƒÙŠ
  smart-cleanup:
    name: ğŸ§¹ Smart Cleanup
    needs: [smart-build-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ§¹ Cleanup Old Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 5 Ø¥ØµØ¯Ø§Ø±Ø§Øª ÙÙ‚Ø·
          echo "ğŸ§¹ Cleaning up old releases (keeping latest 5)..."
          
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª
          RELEASES=$(gh api repos/${{ github.repository }}/releases --paginate | jq -r '.[].id' | tail -n +6)
          
          # Ø­Ø°Ù Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          for release_id in $RELEASES; do
            echo "Deleting old release: $release_id"
            gh api -X DELETE repos/${{ github.repository }}/releases/$release_id || true
          done
          
          echo "âœ… Cleanup completed"
